---
title: "Visual Search and Pre-crastination"
author: "Alasdair D.F. Clarke"
date: '2022-05-30'
output:
  tufte::tufte_html:
    number_sections: true
    fig_height: 3
    link-citations: yes  
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(digits = 3)
set.seed(2022)
```

```{r, message=FALSE}
# attach packages
#library(rethinking)
library(tidyverse)
library(patchwork)
#library(brms)
library(rstan)
library(tidybayes)
library(binom)
```

```{r}
# set ggplot2 options
theme_set(ggthemes::theme_tufte() + 
            theme(plot.background = element_rect(fill = "#fffff8", 
                                                 colour = "#fffff8")))

our_cols <- c("#1b9e77", "#7570b3")
options(ggplot2.discrete.fill = our_cols ,
        ggplot2.discrete.colour = our_cols)
```

# Overview of Visual Search Task

Import data
```{r}
# read in trial data (reponse times and accuracy)
dat_trl <- read_csv("../data/shls_rt_acc.csv", col_types = "cddcdd")

# read in fixation data (only first 20 fixations... see ascii files for full raw data)
dat_fix <- read_csv("../data/processed_fix_data.csv", col_types = "ddddddf")


```

## Reaction Time and Accuracy

```{r}
dat_trl %>%
  group_by(site, person, targ_side_rel) %>%
  summarise(median_rt = median(rt),
            accuracy = mean(accuracy), 
            .groups = "drop") %>%
  mutate(targ_side_rel = fct_relevel(targ_side_rel, "absent")) -> dat_rt_acc

# plot
ggplot(dat_rt_acc, aes(x = median_rt, y = accuracy, colour = site)) + 
  geom_point(alpha = 0.5) +
  scale_x_log10() + 
  geom_hline(yintercept = 0.75, linetype = 2) + 
  facet_wrap(~targ_side_rel)
```

Our pre-registered exclusion rule was to remove anybody achieving less than 75% accuracy in the *absent* and *easy* conditions.

```{r}
dat_rt_acc %>% 
  filter(targ_side_rel != "hard", accuracy < 0.75) %>%
  select(person) -> to_remove

peeps_to_remove <- unique(to_remove$person)

dat_rt_acc %>% 
  filter(!(person %in% peeps_to_remove)) -> dat_rt_acc

# go back and remove from the larger dataset of fixations
dat_fix %>% filter(!(person %in% peeps_to_remove)) -> dat_fix

rm(to_remove)
```

This gives `r length(peeps_to_remove)` participants to remove, leaving us with `r length(unique(dat_rt_acc$person))` participants left (for the visual search part of the experiment).

THIS NEEDS DONE LATER ONCE WE HAVE THE PRECRASTINATION DATA MERGED WITH IT

Now let's do a final plot of accuracy and reaction time:

```{r}
ggplot(dat_rt_acc, aes(x = targ_side_rel, y = accuracy)) + 
         geom_boxplot() -> plt_acc

ggplot(dat_rt_acc, aes(x = targ_side_rel, y = median_rt)) + 
         geom_boxplot() +
  scale_y_log10() -> plt_rt

plt_acc + plt_rt

rm(plt_acc, plt_rt)
```

## Search Strategy

Now to compute our search strategy metric

```{r}
# classify every fixation as homo (right), central, or hetro (left)
centralWidth = 64 #change to 1 visual degree
dat_fix$side <- 'central'
dat_fix$x <- dat_fix$x_flip

dat_fix$side[which(dat_fix$x < (0 - centralWidth/2))] = "hard"
dat_fix$side[which(dat_fix$x > (0 + centralWidth/2))] = "easy"
dat_fix$side = as.factor(dat_fix$side)

dat_fix %>% left_join(dat_trl, by = c("person", "trial", "targ_side_rel")) %>%
  filter(side != "central",
              n < 6, n > 1, 
              targ_side_rel == "absent",
              accuracy == 1) %>% 
  group_by(person, n) %>% 
  summarise(
    prop_hard = mean(side == "hard"), 
    n_trials = length(trial),
    lower = binom.confint(prop_hard*n_trials, n_trials, method = 'wilson')$lower,
    upper = binom.confint(prop_hard*n_trials, n_trials, method = 'wilson')$upper,
    .groups = "drop") -> dat_strat

# also calculate aggregate overall strat and put with rt and acc
dat_strat %>% group_by(person) %>%
  summarise(prop_hard = mean(prop_hard), .groups = "drop") %>%
full_join(dat_rt_acc, by = c("person")) %>%
  mutate(targ_side_rel = fct_relevel(targ_side_rel, "easy","hard")) -> dat_shls

write_csv(dat_shls, "scratch/dat_rt_acc_strat.csv")
```

# Pre-crastination

## Do people pre-crastinate?

```{r}
dat <- read_csv("../data/pre_crastinate.csv", col_types = "iif") 

summary(dat)
```

We have data from `r length(dat)/6` people and no missing data. 

First, report number of people who *double pre-crastinate*:

```{r}
dat %>% filter(choice == "double_pre_cra") %>% 
  group_by(person, site) %>%
  summarise(n_trials_precrastinated = n(),
            .groups = "drop") %>%
  group_by(site, n_trials_precrastinated) %>%
  summarise(num_people = n(), 
            .groups = "drop") -> dpc

knitr::kable(dpc)
```

We find that `r sum(dpc$num_people)` out of `r length(unique(dat$person))` participants *double pre-crastinated* at least once. Out of these, `r filter(dpc, n_trials_precrastinated==6)$num_people` did so on all six trials.

As this is another form of pre-crasination, we will not distinguish between these participants and those who pre-crastinate normally. 

```{r}
rm(dpc)
```

```{r}
dat %>% 
  group_by(person, site) %>%
  summarise(
    sensible = sum(choice == "sensible"),
    pre_crastinate = sum(choice != "sensible")) %>%
  mutate(
    classification = case_when(
      sensible > 4 ~ "no",
      sensible < 3 ~ "yes",
      TRUE ~ "intermediate"),
    classification = as_factor(classification),
    classification = fct_relevel(classification, 
                                 "no", "intermediate", "yes")) %>%
  select(person, site,
         n_pc = pre_crastinate, 
         pre_crastinate = "classification") %>%
  full_join(dat_shls) %>% na.omit -> dat

write_csv(dat, "scratch/pre_crastinate_clean.csv")
```

We have `r length(unique(dat$person))` people with data for both visual search and pre-crastination. 


# Personality

Read in personality data and compute overall scores



